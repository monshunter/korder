# korder

[![License](https://img.shields.io/badge/license-Apache%202.0-blue.svg)](LICENSE)
[![Go Report Card](https://goreportcard.com/badge/github.com/monshunter/korder)](https://goreportcard.com/report/github.com/monshunter/korder)
[![Kubernetes](https://img.shields.io/badge/kubernetes-%231.28+-blue.svg)](https://kubernetes.io/)

ä¸­æ–‡ | [English](README.md)

**korder** æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ Kubernetes èµ„æºè®¢å•ç³»ç»Ÿï¼Œé€šè¿‡è®¢å•å’Œç¥¨æ®æœºåˆ¶ä¿è¯èµ„æºåˆ†é…ã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                korder ç³»ç»Ÿæ¶æ„                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  ç”¨æˆ·/åº”ç”¨                                                                       â”‚
â”‚    â”‚                                                                            â”‚
â”‚    â”‚ 1. åˆ›å»º Order                                                               â”‚
â”‚    â”‚                                                                            â”‚
â”‚    â–¼                                                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”    2. åˆ›å»º Tickets    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€--â”€â”                 â”‚
â”‚ â”‚  Order Controllerâ”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ Ticket Controllerâ”‚                 â”‚
â”‚ â”‚                  â”‚                       â”‚                  â”‚                 â”‚
â”‚ â”‚ â€¢ ç®¡ç†è®¢å•ç”Ÿå‘½å‘¨æœŸ  â”‚                       â”‚ â€¢ ç®¡ç†ç¥¨æ®ç”Ÿå‘½å‘¨æœŸ  â”‚                 â”‚
â”‚ â”‚ â€¢ æ ¹æ®ç­–ç•¥åˆ›å»ºç¥¨æ®  â”‚                       â”‚ â€¢ åˆ›å»ºå®ˆæŠ¤è€… Pod   â”‚                 â”‚
â”‚ â”‚ â€¢ å¤„ç†è°ƒåº¦å’Œæ›´æ–°   â”‚                       â”‚ â€¢ ç»‘å®šä¸šåŠ¡ Pod     â”‚                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”˜                  â”‚
â”‚                                                    â”‚                             â”‚
â”‚                                           3. åˆ›å»ºå®ˆæŠ¤è€…Pod                         â”‚
â”‚                                                    â”‚                             â”‚
â”‚                                                    â–¼                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚ â”‚ Quota Controllerâ”‚                       â”‚   Guardian Pod  â”‚                    â”‚
â”‚ â”‚                 â”‚                       â”‚                 â”‚                    â”‚
â”‚ â”‚ â€¢ èµ„æºé…é¢ç®¡ç†    â”‚                       â”‚ â€¢ æŒæœ‰èµ„æºé¢„ç•™    â”‚                    â”‚
â”‚ â”‚ â€¢ å¤šèŒƒå›´é™åˆ¶      â”‚                       â”‚ â€¢ ç­‰å¾…ä¸šåŠ¡ç»‘å®š    â”‚                    â”‚
â”‚ â”‚ â€¢ æ—¶é—´çª—å£é…é¢    â”‚                       â”‚ â€¢ è‡ªåŠ¨è¿‡æœŸæ¸…ç†    â”‚                    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚          â”‚                                                                       â”‚
â”‚          â”‚ 4. é…é¢éªŒè¯                                                            â”‚
â”‚          â”‚                                                                       â”‚
â”‚          â–¼                                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    5. æ‹¦æˆªPodåˆ›å»º     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ â”‚ Admission       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   Business Pod  â”‚                    â”‚
â”‚ â”‚ Webhook         â”‚                      â”‚                 â”‚                    â”‚
â”‚ â”‚                 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â€¢ å£°æ˜èµ„æºéœ€æ±‚    â”‚                    â”‚
â”‚ â”‚ â€¢ éªŒè¯Order/Quotaâ”‚    6. ç»‘å®šåˆ°Ticket    â”‚ â€¢ ç»‘å®šåˆ°ç¥¨æ®     â”‚                     â”‚
â”‚ â”‚ â€¢ æ‹¦æˆªPodåˆ›å»º    â”‚                      â”‚ â€¢ ä½¿ç”¨é¢„ç•™èµ„æº    â”‚                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              æ ¸å¿ƒå·¥ä½œæµç¨‹                                         â”‚
â”‚                                                                                 â”‚
â”‚ 1. ç”¨æˆ·åˆ›å»º Orderï¼Œå£°æ˜èµ„æºéœ€æ±‚å’Œæ•°é‡                                                â”‚
â”‚ 2. Order Controller æ ¹æ®ç­–ç•¥åˆ›å»ºå¯¹åº”æ•°é‡çš„ Tickets                                  â”‚
â”‚ 3. Ticket Controller ä¸ºæ¯ä¸ª Ticket åˆ›å»º Guardian Pod æŒæœ‰èµ„æº                      â”‚
â”‚ 4. Quota Controller éªŒè¯èµ„æºä½¿ç”¨æ˜¯å¦ç¬¦åˆé…é¢é™åˆ¶                                     â”‚
â”‚ 5. ç”¨æˆ·åˆ›å»ºä¸šåŠ¡ Pod æ—¶ï¼ŒAdmission Webhook æ‹¦æˆªå¹¶ç»‘å®šåˆ°åˆé€‚çš„ Ticket                   â”‚
â”‚ 6. Guardian Pod è¢«åˆ é™¤ï¼Œä¸šåŠ¡ Pod è·å¾—é¢„ç•™çš„èµ„æº                                      â”‚
â”‚ 7. Ticket è¢«æ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼Œæˆ–åœ¨è¿‡æœŸåè‡ªåŠ¨æ¸…ç†                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **ğŸ¯ èµ„æºé¢„ç•™**: é€šè¿‡å®ˆæŠ¤è€… Pod é¢„å…ˆåˆ†é…å’ŒæŒæœ‰èµ„æº
- **ğŸ“‹ å£°æ˜å¼è®¢å•**: ä½¿ç”¨ Order CRD å£°æ˜èµ„æºéœ€æ±‚å’Œç®¡ç†ç­–ç•¥  
- **ğŸ« ç¥¨æ®æœºåˆ¶**: Ticket æä¾›ç»†ç²’åº¦çš„èµ„æºåˆ†é…å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- **ğŸ“Š é…é¢ç®¡ç†**: å¤šå±‚çº§ã€å¤šèŒƒå›´çš„èµ„æºé…é¢æ§åˆ¶
- **â° æ—¶é—´è°ƒåº¦**: æ”¯æŒä¸€æ¬¡æ€§ã€å®šæ—¶å’Œå‘¨æœŸæ€§èµ„æºåˆ†é…ç­–ç•¥
- **ğŸ” è‡ªåŠ¨å‘ç°**: é€šè¿‡ Admission Webhook è‡ªåŠ¨ç»‘å®šä¸šåŠ¡ Pod åˆ°é¢„ç•™èµ„æº
- **ğŸ—‚ï¸ å¤šç§ç­–ç•¥**: OneTimeã€Scheduledã€Recurring ç­‰ä¸åŒçš„èµ„æºåˆ†é…æ¨¡å¼

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

- Kubernetes 1.28+
- kubectl é…ç½®å¹¶è¿æ¥åˆ°é›†ç¾¤
- é›†ç¾¤ç®¡ç†å‘˜æƒé™ï¼ˆå®‰è£… CRDs å’Œ RBACï¼‰

### å®‰è£… korder

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨é¢„æ„å»ºçš„å®‰è£…æ–‡ä»¶

```bash
# å®‰è£… CRDs å’Œæ§åˆ¶å™¨
kubectl apply -f https://github.com/monshunter/korder/releases/latest/download/install.yaml

# éªŒè¯å®‰è£…
kubectl get pods -n korder-system
```

#### æ–¹æ³•äºŒï¼šä»æºç æ„å»º

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/monshunter/korder.git
cd korder

# å®‰è£… CRDs
make install

# éƒ¨ç½²æ§åˆ¶å™¨åˆ°é›†ç¾¤
make deploy

# éªŒè¯éƒ¨ç½²
kubectl get pods -n korder-system
```

#### æ–¹æ³•ä¸‰ï¼šæœ¬åœ°å¼€å‘è¿è¡Œ

```bash
# å®‰è£… CRDs
make install

# æœ¬åœ°è¿è¡Œæ§åˆ¶å™¨ï¼ˆéœ€è¦æœ‰æ•ˆçš„ kubeconfigï¼‰
make run
```

### åŸºç¡€ä½¿ç”¨ç¤ºä¾‹

#### 1. åˆ›å»ºç®€å•çš„èµ„æºè®¢å•

```yaml
apiVersion: core.korder.dev/v1alpha1
kind: Order
metadata:
  name: my-order
  namespace: default
spec:
  # åˆ›å»º 3 ä¸ªç¥¨æ®
  replicas: 3
  
  # ä¸€æ¬¡æ€§ç­–ç•¥
  strategy:
    type: OneTime
    refreshPolicy: OnClaim
  
  # ç¥¨æ®æ¨¡æ¿
  template:
    metadata:
      labels:
        app: my-application
    spec:
      # ç¥¨æ®æœ‰æ•ˆæœŸ 24 å°æ—¶
      duration: 24h
      
      # èµ„æºéœ€æ±‚
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 1000m
          memory: 2Gi
      
      # èŠ‚ç‚¹é€‰æ‹©
      nodeSelector:
        node-type: compute
```

```bash
# åº”ç”¨è®¢å•
kubectl apply -f order.yaml

# æŸ¥çœ‹è®¢å•çŠ¶æ€
kubectl get orders

# æŸ¥çœ‹ç”Ÿæˆçš„ç¥¨æ®
kubectl get tickets

# æŸ¥çœ‹å®ˆæŠ¤è€… Pod
kubectl get pods -l korder.dev/role=guardian
```

#### 2. åˆ›å»ºä½¿ç”¨é¢„ç•™èµ„æºçš„ä¸šåŠ¡ Pod

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-business-pod
  annotations:
    # å£°æ˜éœ€è¦ä½¿ç”¨ korder èµ„æº
    korder.dev/required: "true"
    # å¯é€‰ï¼šæŒ‡å®šä½¿ç”¨ç‰¹å®šè®¢å•
    korder.dev/order: "my-order"
spec:
  containers:
  - name: app
    image: nginx:latest
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 2Gi
```

```bash
# åˆ›å»ºä¸šåŠ¡ Pod
kubectl apply -f business-pod.yaml

# æŸ¥çœ‹ Pod æ˜¯å¦æˆåŠŸç»‘å®šåˆ°ç¥¨æ®
kubectl get pods my-business-pod -o yaml | grep korder.dev/

# æŸ¥çœ‹ç¥¨æ®çŠ¶æ€å˜åŒ–
kubectl get tickets -o wide
```

#### 3. å®šæ—¶èµ„æºè®¢å•

```yaml
apiVersion: core.korder.dev/v1alpha1
kind: Order
metadata:
  name: scheduled-order
  namespace: default
spec:
  replicas: 2
  
  # æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œ
  strategy:
    type: Scheduled
    schedule: "0 2 * * *"
    refreshPolicy: Always
  
  template:
    spec:
      duration: 8h  # 8 å°æ—¶çª—å£
      resources:
        requests:
          cpu: 200m
          memory: 512Mi
```

#### 4. é…ç½®èµ„æºé…é¢

```yaml
apiVersion: core.korder.dev/v1alpha1
kind: Quota
metadata:
  name: team-quota
spec:
  # ä½œç”¨äºç‰¹å®šå‘½åç©ºé—´
  scope:
    type: NamespaceSelector
    namespaceSelector:
      matchLabels:
        team: "backend"
  
  # èµ„æºé™åˆ¶
  hard:
    orders: "10"              # æœ€å¤š 10 ä¸ªè®¢å•
    tickets: "50"             # æœ€å¤š 50 ä¸ªç¥¨æ®
    reserved.cpu: "20"        # æœ€å¤šé¢„ç•™ 20 æ ¸ CPU
    reserved.memory: "40Gi"   # æœ€å¤šé¢„ç•™ 40GB å†…å­˜
    max-duration: "24h"       # æœ€å¤§é¢„ç•™æ—¶é—´ 24 å°æ—¶
```

### ç›‘æ§å’Œè°ƒè¯•

```bash
# æŸ¥çœ‹æ‰€æœ‰ korder èµ„æº
kubectl get orders,tickets,quotas --all-namespaces

# æŸ¥çœ‹æ§åˆ¶å™¨æ—¥å¿—
kubectl logs -n korder-system deployment/korder-controller-manager -f

# æŸ¥çœ‹ç‰¹å®šè®¢å•çš„äº‹ä»¶
kubectl describe order my-order

# æŸ¥çœ‹ç¥¨æ®è¯¦æƒ…
kubectl describe ticket <ticket-name>

# æ£€æŸ¥é…é¢ä½¿ç”¨æƒ…å†µ
kubectl describe quota team-quota
```

## ğŸ“š é«˜çº§ç”¨æ³•

### è°ƒåº¦ç­–ç•¥

- **OneTime**: ä¸€æ¬¡æ€§åˆ›å»ºï¼Œç¥¨æ®è¢«ä½¿ç”¨åæ ¹æ® refreshPolicy å†³å®šæ˜¯å¦é‡æ–°åˆ›å»º
- **Scheduled**: æŒ‰ cron è¡¨è¾¾å¼å®šæ—¶åˆ›å»ºç¥¨æ®
- **Recurring**: å‘¨æœŸæ€§åˆ›å»ºç¥¨æ®ï¼Œæ”¯æŒå¤æ‚çš„æ—¶é—´æ¨¡å¼

### é…é¢ç®¡ç†

- **å¤šèŒƒå›´æ”¯æŒ**: Clusterã€NamespaceSelectorã€NamespaceListã€ObjectSelector
- **æ—¶é—´çª—å£**: ä¸åŒæ—¶é—´æ®µçš„ä¸åŒèµ„æºé™åˆ¶
- **å±‚çº§åˆ†é…**: ä¸ºä¸åŒç¯å¢ƒåˆ†é…å­é…é¢

### ç”Ÿå‘½å‘¨æœŸç®¡ç†

- **TTL æ§åˆ¶**: ç¥¨æ®å®Œæˆåçš„ä¿ç•™æ—¶é—´
- **æ¸…ç†ç­–ç•¥**: Delete æˆ– Retain
- **è¿‡æœŸå¤„ç†**: è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ç¥¨æ®å’Œå®ˆæŠ¤è€… Pod

## ğŸ› ï¸ å¼€å‘

```bash
# æ„å»ºé¡¹ç›®
make build

# è¿è¡Œæµ‹è¯•
make test

# è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
make test-e2e

# ä»£ç æ£€æŸ¥
make lint

# ç”Ÿæˆä»£ç å’Œæ¸…å•
make generate manifests
```

è¯¦ç»†çš„å¼€å‘æŒ‡å—è¯·å‚è€ƒ [CLAUDE.md](CLAUDE.md)ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä½¿ç”¨ [Apache 2.0](LICENSE) è®¸å¯è¯ã€‚